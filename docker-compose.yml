version: '3.7'

services:
  db:
    image: neo4j:4.1
    restart: always
    ports:
    - 7687:7687
    environment:
    - NEO4J_AUTH=${NEO4J_AUTH}
    - NEO4JLABS_PLUGINS=["apoc"]
    volumes:
    - ${PWD}/data:/data:Z
    - ${PWD}/logs:/logs:Z
  api:
    build:
      context: api/
      args:
        VERSION: ${DATACAT_VERSION}
    depends_on:
      - db
    restart: always
    environment:
      - spring.data.neo4j.uri=bolt://db:7687
      - spring.data.neo4j.username=${NEO4J_USERNAME}
      - spring.data.neo4j.password=${NEO4J_PASSWORD}
  explorer:
    image: bentrm/datacat:${DATACAT_EXPLORER_VERSION:-latest-explorer}
    restart: always
  prometheus:
    image: prom/prometheus:latest
    depends_on:
      - api
    volumes:
      - ${PWD}/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - metrics:/prometheus
    ports:
      - ${PORT_METRICS:-9090}:9090
  proxy:
    build: proxy/
    depends_on:
      - api
      - explorer
    ports:
      - ${PORT:-3000}:80

volumes:
  metrics:
